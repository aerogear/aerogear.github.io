<!doctype html>
<html>
<head>
  <title>AeroGear - AeroGear Sync Client API Proposals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Main styles-->
  <link href="/css/styles.css" rel="stylesheet" media="screen">

  <!-- Syntax highlighting -->
  <link href="/css/syntax.css" rel="stylesheet"> 

  <!-- Icons -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/css/openshift-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>


  <!-- google analytics -->
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28733717-2']);
      _gaq.push(['_setDomainName', 'aerogear.org']);
      _gaq.push(['_trackPageview']);

      (function () {
          var ga = document.createElement('script');
          ga.type = 'text/javascript';
          ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
  </script>
  

</head>

<body>    

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">AeroGear</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        

        <li class="">
          <a href="/">Home</a>
        </li>

        <li class="">
          <a href="/getting-started/overview/">Getting Started</a>
        </li>


        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile Services<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
              <li><a href="/services/push/">Push Notifications</a></li>
              <li><a href="/services/metrics/">Metrics</a></li>
              <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
              <li><a href="/services/identity-management/">Identity Management</a></li>
              <li><a href="/services/device-security/">Device Security</a></li>
            </ul>
        </li>

        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile SDKs<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/sdks/android/">Android</a></li>
            <li><a href="/sdks/cordova/">Cordova</li>
            <li><a href="/sdks/ios/">iOS</a></li>
            <li><a href="/sdks/xamarin/">Xamarin</a></li>
          </ul>
        </li>

        <li class="hidden-sm active">
          <a href="https://docs.aerogear.org">Docs</a>
        </li>
   
        
        <li class="">
          <a href="/community">Community</a>
        </li>
        

        <li class="">
          <a href="/news">News</a>
        </li>
        
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<section class="main-banner">
  <div class="container">
    
  <h2>Documentation <small>Aerogear API documentation &amp; specifications.</small></h2>

  </div><!-- container -->
</section> <!-- main banner -->


<section class="docs">
  
  <div class="container">
         <ol class="breadcrumb" style="margin:0">
      <li>
        
          <a href="/docs/specs/">Docs</a>
        
      </li>
      <li class="active">AeroGear Sync Client API Proposals</li>
    </ol>
  </div><!-- container -->


  <div class="container">
    <div class="row">
      
      <div class="col-md-3 hidden-sm hidden-xs sidebar">
        <ul class="nav">
   <li class="toc_level-1 toc_section-1">
      <a href="#summers-proposal">
         <span class="toctext">Summers’ Proposal</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-2">
            <a href="#overview">
               <span class="toctext">Overview</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-3">
            <a href="#usage-android">
               <span class="toctext">Usage (Android)</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-4">
            <a href="#general-classes">
               <span class="toctext">General Classes</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-5">
            <a href="#methods-1">
               <span class="toctext">Methods</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-6">
            <a href="#android-specific-classes">
               <span class="toctext">Android specific classes</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-7">
            <a href="#periodic-read-only-update">
               <span class="toctext">Periodic Read Only Update</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-8">
            <a href="#topics-not-addressed">
               <span class="toctext">Topics not addressed</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-9">
      <a href="#edewits-proposal">
         <span class="toctext">Edewit’s proposal</span>
      </a>
   </li>
</ul>
      </div><!-- col -->
      
      <div class="col-md-9 post">
      
        <h1>AeroGear Sync Client API Proposals</h1>
        <p><span class="label label-warning">Status: Experimental</span></p>

<h2 id="summers-proposal">Summers’ Proposal</h2>

<p>(Java flavored)</p>

<h3 id="overview">Overview</h3>

<p>The Client API I propose bridges Datastores, Pipes, and Push technologies.</p>

<p>Currently, the user has to manually signal an intent to push his changes to a remote service.  However, the push subsystem takes care of receiving updates from a server.</p>

<p>This strawman is biased towards Java, but as we discuss it we can move toward a more generic document.</p>

<p>This straw man is still very limited.  Implementation specific limitations are described with their respective classes, but in general I have not yet proposed solutions for offline support, conflict resolution and detection, etc.</p>

<h3 id="usage-android">Usage (Android)</h3>

<p>Before we get into the APIs I would like to demonstrate a usage example for two way settings sync.</p>

<p><a href="https://plus.google.com/+SummersPittman/posts/HGVHwtPArPW">DevNexus App demo video</a></p>

<h4 id="setupjava">Setup.java</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TwoWaySqlSynchronizer&lt;UserCalendar&gt; userCalendarSync;
TwoWaySqlSynchronizerConfig syncConfig = new TwoWaySqlSynchronizer.TwoWaySqlSynchronizerConfig();
syncConfig.setKlass(UserCalendar.class);
syncConfig.setPipeConfig(userCalendarPipeConfig);
syncConfig.setStoreConfig(userCalendarStoreConfig);

userCalendarSync = new TwoWaySqlSynchronizer&lt;UserCalendar&gt;(syncConfig);

userCalendarSync.beginSync(this, callback);

userCalendarSync.resetToRemoteState(new Callback&lt;List&lt;UserCalendar&gt;&gt;() {
    @Override
    public void onSuccess(final List&lt;UserCalendar&gt; schedules) {

        mainLoopHandler.post(new Runnable() {
            @Override
            public void run() {
                adapter.update(schedules);
            }
        });

    }

    @Override
    public void onFailure(Exception e) {
        Log.e("LOAD_CAL", e.getMessage(), e);
    }
});
</code></pre></div></div>

<h4 id="syncing-changes">Syncing Changes</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>userCalendarSync.sync();
</code></pre></div></div>

<h4 id="handling-remote-changes">Handling Remote Changes</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//Note, the class these methods are members of extends Fragment and implements SynchronizeEventListener&lt;UserCalendar&gt;

@Override
public void onResume() {
    super.onResume();
    userCalendarSync.addListener(this);
}

@Override
public void onPause() {
    super.onPause();
    userCalendarSync.removeListener(this);
}


@Override
public void dataUpdated(Collection&lt;UserCalendar&gt; newData) {
    adapter.update(new ArrayList&lt;UserCalendar&gt;(newData));
    adapter.notifyDataSetChanged();
}
</code></pre></div></div>

<h4 id="androidmanifestxml">AndroidManifest.xml</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> &lt;receiver
        android:name="org.devnexus.sync.AeroGearGCMSyncMessageReceiver"
        android:permission="com.google.android.c2dm.permission.SEND" &gt;
        &lt;intent-filter&gt;
            &lt;action android:name="com.google.android.c2dm.intent.RECEIVE" /&gt;
            &lt;category android:name="org.devnexus" /&gt;
        &lt;/intent-filter&gt;
        &lt;meta-data android:name="SYNC_PROVIDER_KEY" android:value="org.devnexus.sync.DevnexusCalendarSyncProvider"/&gt;
        &lt;meta-data android:name="SYNC_MESSAGE_KEY" android:value="org.devnexus.sync.UserCalendar"/&gt;
    &lt;/receiver&gt;
</code></pre></div></div>

<h3 id="general-classes">General Classes</h3>

<p>The following classes should be applicable over all implementations.</p>

<h4 id="synchronizeeventlistener">SynchronizeEventListener</h4>

<p>Objects which implement this pattern will be notified by the sync subsystem when a change has occurred.</p>

<h5 id="methods">Methods</h5>

<dl>
  <dt>dataUpdated <strong><em>void</em></strong> <strong>newData</strong></dt>
  <dd>This is called when data has been successfully synced with no conflicts.  The newData parameter is the new synced object.</dd>
  <dt>resolveConflicts <strong><em>resolvedData</em></strong> <strong>localData, remoteData</strong></dt>
  <dd>This is called when data needs to be resolved.  The method is provided with a copy of the local data and the remote data.  The returned value is the resolved state.  The sync subsystem will attempt to resolve the returned state with the remote server.  If this is successful, dataUpdated will be called.</dd>
</dl>

<h4 id="synchronizer">Synchronizer</h4>

<p>Objects which implement this pattern will be responsible for scheduling synchronization and listeners.</p>

<h3 id="methods-1">Methods</h3>

<dl>
  <dt>addListener <strong><em>void</em></strong> <strong>listener</strong></dt>
  <dd>This method registers a instance of a SynchronizeEventListener with this Synchronizer</dd>
  <dt>removeListener <strong><em>void</em></strong> <strong>listener</strong></dt>
  <dd>This method unregisters a instance of a SynchronizeEventListener with this Synchronizer</dd>
  <dt>beginSync <strong><em>void</em></strong> <strong>appContext</strong></dt>
  <dd>This method will preform all the necessary tasks for beginning synchronization including scheduling, sending tokens to the server, etc.</dd>
  <dt>stopSync <strong><em>void</em></strong></dt>
  <dd>This method unregisters the app from synchronization.  It will also perform any necessary cleanup.  This method does not necessarily remove data.</dd>
  <dt>loadRemoteChanges <strong><em>void</em></strong></dt>
  <dd>This method will download <em>update</em> the current working data with the remote <em>changes</em>.</dd>
  <dt>sync <strong><em>void</em></strong></dt>
  <dd>Notify the synchronizer that local data has been changed and should be sent to the remote server for update.</dd>
  <dt>resetToRemoteState <strong><em>void</em></strong> <strong>Callback</strong></dt>
  <dd>This will download the remote data and replace the local data with it.</dd>
</dl>

<h4 id="twowaysqlsynchronizer--synchronizer">TwoWaySqlSynchronizer :: Synchronizer</h4>

<p>This Synchronizer will examine a local data store and send changes to the server.  It does this by maintaining a reference to an external SQLStore and an internal reference to a Shadow SQL Store.  The Shadow store is updated when synchronization happens to generate a change list to send to the server or apply to the local data store.</p>

<p>One of the “neat” things about this synchronizer is that since GCM handles offline state, we will only receive messages when the device is online.  Thus we don’t have to worry about online/offline detection.  We still have to worry about conflict detection and resolution however.</p>

<h4 id="periodicreadonlysynchronizer---synchronizer">PeriodicReadOnlySynchronizer  :: Synchronizer</h4>

<p>This synchronizer may store data in any store and refreshes its data from the server on a schedule provided by its config object.</p>

<h4 id="syncconfig">SyncConfig</h4>

<p>Properties on this object are used to configure Synchronizers.  Individual synchronizers may extends this class to include their own properties.</p>

<h4 id="properties">Properties</h4>

<dl>
  <dt>klass <strong>Class</strong></dt>
  <dd>This is the class type of the Synchronizer.  Objects managed by the Synchronizer of are this type</dd>
  <dt>pipeConfig <strong>PipeConfig</strong></dt>
  <dd>The synchronizer will create a pipe based on this config to send data changes following the Pipe API.</dd>
  <dt>storeConfig <strong>StoreConfig</strong></dt>
  <dd>The synchronizer will use this data to create or access a local datastore.</dd>
  <dt>type <strong>SyncType</strong></dt>
  <dd>This is the type of synchronizer this class configures (PeriodicReadOnlySync, TwoWaySqlSync, etc)</dd>
</dl>

<h3 id="android-specific-classes">Android specific classes</h3>

<p>The following classes are specific to Android but may serve as a referenc for others.</p>

<h4 id="aerogeargcmsyncmessagereceiver--broadcastreceiver">AeroGearGCMSyncMessageReceiver :: BroadcastReceiver</h4>

<p>This class listens for GCM messages from Google and sends signals to a configured Synchronizer to load the remote changes.</p>

<h5 id="properties-provided-in-manifestxml">Properties provided in Manifest.xml</h5>

<dl>
  <dt>SYNC_PROVIDER_KEY</dt>
  <dd>This is the fully qualified name of a Provider whose get method returns the Synchronizer AeroGearGCMSyncMessageReceiver is receiver messages for.</dd>
  <dt>SYNC_MESSAGE_KEY</dt>
  <dd>This is a key which should be present in the GCM message to signal that which data type has been updated.  If this key is not present the Synchronizer will not be called for this message.</dd>
</dl>

<h4 id="synctimerreceiver--broadcastreceiver">SyncTimerReceiver :: BroadcastReceiver</h4>

<p>This class listens for Alarms invoked by the Android Alarm manager.  It will call inform a sychronizer to synchronize based on a clock.</p>

<h4 id="properties-provided-in-manifestxml-1">Properties provided in Manifest.xml</h4>

<dl>
  <dt>SYNC_PROVIDER_KEY</dt>
  <dd>This is the fully qualified name of a Provider whose get method returns the Synchronizer which should be updated.</dd>
  <dt>SYNC_MESSAGE_KEY</dt>
  <dd>This is a key which should be present in the alarm intent.  It will be used by the Receiver to route update messages to the correct synchronizer.</dd>
</dl>

<h3 id="periodic-read-only-update">Periodic Read Only Update</h3>

<p>Use cases where caching data is useful and where it should be transparent and long lived are covered by this.</p>

<h4 id="usage-proposal-reading-a-schedule-android">Usage proposal: Reading a schedule (Android)</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PipeConfig pipeConfig = buildConfig()

SyncConfig syncConfig = new SyncConfig();
syncConfig.setType(SyncTypes.PeriodicReadOnly);
syncConfig.setExpiresIn(SyncConfig.24_HOURS);

pipeConfig.setSync(syncConfig);

Pipe&lt;Schedule&gt; schedulePipe = pipeline.pipe(pipeConfig);

schedulePipe.read(/*call back*/);
/*
This will check a SQL Store, notice there is no data, fetch the data, and store metadata about when it was fetched.
*/

//12 Hours later
schedulePipe.read(/*call back*/);
/*
This will check a SQL Store, notice there is data, notice it is inside of the expires time, and return it.
No call to the remote source will be made.
*/

//36 Hours later
schedulePipe.read(/*call back*/);
/*
This will check a SQL Store, notice there is data, notice it is stale, and refetch and refresh the data.
*/
</code></pre></div></div>

<h3 id="topics-not-addressed">Topics not addressed</h3>

<ul>
  <li>Data life cycle</li>
  <li>Security</li>
  <li>Conflict detection</li>
</ul>

<h2 id="edewits-proposal">Edewit’s proposal</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// [option 1 fully automatic we create a pipe and add the posibilty to add a store for failover and sync just happens at on- and offline events]
// and because merging can fail users can add a conflict handlers

Builder builder = Builder.createPipe(pipeConfig).addFailoverStore(storeConfig);
Pipe&lt;Car&gt; pipe = builder.pipe(Car.class);

pipe.addConfictHandler(new ConflictHandler() {
  public void conflict(Field originalField, Field newField) {
  // user interaction
  }
});

// [option 2 explicit let the user specify when to sync and what to sync]
SyncedPipe pipe = SyncPipeBuilder.build(options); // SyncPipe Store and Pipe togheter

// or we only use a store to sync and tell the sync manager where to sync to
SyncManager syncManager = new SyncManger();
syncManger.filter(readFilter); // maybe we don't want to sync all data but just some part

syncManager.addConnectionHandler(new ConnectionHandler() {
  public void onConnection() {
  syncManger.sync(pipe);
  }
});

syncManger.addConfictHandler(new ConflictHandler() {
  public void conflict(Field original, Field new) {
  // user interaction
  }
});
</code></pre></div></div>


      
      </div><!-- col 8 -->
    </div><!-- row -->
  </div><!-- container -->
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-sm-3">
        <h5>Getting Started</h5>
        <ul class="list-unstyled">
          <li><a href="/getting-started/overview/">Overview</a></li>
          <li><a href="/getting-started/installation-and-configuration/">Installation &amp; Configuration</a></li>
          <li><a href="/getting-started/creating-mobile-apps/">Creating Mobile Apps</a></li>
          <li><a href="/getting-started/enabling-mobile-services/">Enabling Mobile Services</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile Services</h5>
        <ul class="list-unstyled">
         <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
         <li><a href="/services/push/">Push Notifications</a></li>
         <li><a href="/services/metrics/">Metrics</a></li>
         <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
         <li><a href="/services/identity-management/">Identity Management</a></li>
         <li><a href="/services/device-security/">Device Security</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile SDKs</h5>
        <ul class="list-unstyled">
         <li><a href="/sdks/android/">Android</a></li>
         <li><a href="/sdks/cordova/">Cordova</li>
         <li><a href="/sdks/ios/">iOS</a></li>
         <li><a href="/sdks/xamarin/">Xamarin</a></li>
        </ul>
      </div><!-- col -->
      
      <div class="col-sm-3">
        <h5>COMMUNITY</h5>
        <ul class="list-unstyled">
          <li><a target="_blank" href="https://github.com/aerogear/">GitHub - Aerogear</a></li>
          <li><a target="_blank" href="https://github.com/aerogearcatalog/">GitHub - Aerogear Catalog</a></li>
          <li><a target="_blank" href="https://issues.jboss.org/browse/AEROGEAR">Jira Repo Issues</a></li>
          <li><a  href="/community/contribution-guide/">Contribution Guide</a></li>
          <li><a target="_blank" href="https://groups.google.com/forum/#!forum/aerogear">Google Group</a></li>
          <li><a href="irc://irc.freenode.net/aerogear">IRC</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-12 follow">
        <h5>FOLLOW US</h5>
        <ul class="list-inline">
          <li><a target="_blank" href="https://www.twitter.com/aerogears"><i class="fa fa-twitter-square"></i> Twitter</a></li>
          <li><a target="_blank" href="https://www.facebook.com/AeroGearProject"><i class="fa fa-facebook-square"></i> Facebook</a></li>
          <li><a target="_blank" href="https://plus.google.com/106588661437153585722/posts"><i class="fa fa-google-plus-square"></i> Google+</a></li>
          <li><a target="_blank" href="/feed.atom"><i class="fa fa-rss-square"></i> Feed</a></li>
        </ul>
        
        <p>AeroGear project is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a></p>
      </div><!-- col -->
    
    </div><!-- row -->

  </div><!-- container -->

</footer><!-- footer -->

<section class="redhat">
  <div class="container">
    <p class="text-center">
      <a href="http://www.redhat.com/">
        <img src="/img/redhatlogo-wite.png" alt="redhatlogo-wite" width="130">
      </a>
    </p>       
  </div><!-- container -->
</section>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!-- <script src="/bower_components/jquery/dist/jquery.min.js"></script> -->

<!-- Include all compiled plugins (below), or include individual files as needed  -->  
<script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- My script -->
<script src="/js/script.js"></script>

</body>
</html>