<!doctype html>
<html>
<head>
  <title>AeroGear - Offline Storage Specification (OSS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Main styles-->
  <link href="/css/styles.css" rel="stylesheet" media="screen">

  <!-- Syntax highlighting -->
  <link href="/css/syntax.css" rel="stylesheet"> 

  <!-- Icons -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/css/openshift-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>


  <!-- google analytics -->
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28733717-2']);
      _gaq.push(['_setDomainName', 'aerogear.org']);
      _gaq.push(['_trackPageview']);

      (function () {
          var ga = document.createElement('script');
          ga.type = 'text/javascript';
          ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
  </script>
  

</head>

<body>    

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">AeroGear</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        

        <li class="">
          <a href="/">Home</a>
        </li>

        <li class="">
          <a href="/getting-started/overview/">Getting Started</a>
        </li>


        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile Services<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
              <li><a href="/services/push/">Push Notifications</a></li>
              <li><a href="/services/metrics/">Metrics</a></li>
              <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
              <li><a href="/services/identity-management/">Identity Management</a></li>
              <li><a href="/services/device-security/">Device Security</a></li>
            </ul>
        </li>

        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile SDKs<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/sdks/android/">Android</a></li>
            <li><a href="/sdks/cordova/">Cordova</li>
            <li><a href="/sdks/ios/">iOS</a></li>
            <li><a href="/sdks/xamarin/">Xamarin</a></li>
          </ul>
        </li>

        <li class="hidden-sm active">
          <a href="https://docs.aerogear.org">Docs</a>
        </li>
   
        
        <li class="">
          <a href="/community">Community</a>
        </li>
        

        <li class="">
          <a href="/news">News</a>
        </li>
        
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<section class="main-banner">
  <div class="container">
    
  <h2>Documentation <small>Aerogear API documentation &amp; specifications.</small></h2>

  </div><!-- container -->
</section> <!-- main banner -->


<section class="docs">
  
  <div class="container">
         <ol class="breadcrumb" style="margin:0">
      <li>
        
          <a href="/docs/specs/">Docs</a>
        
      </li>
      <li class="active">Offline Storage Specification (OSS)</li>
    </ol>
  </div><!-- container -->


  <div class="container">
    <div class="row">
      
      <div class="col-md-8 col-md-offset-2 post">
      
        <h1>Offline Storage Specification (OSS)</h1>
        <h1 id="status-experimental-001">Status: Experimental (0.0.1)</h1>

<p><strong>Note</strong>: This document is a working progress if you strongly disagree with something, feedback is welcome.</p>

<h1 id="authors">Authors</h1>

<ul>
  <li><a href="http://blog.abstractj.org/contact/">Bruno Oliveira</a></li>
  <li>Daniel Passos</li>
</ul>

<h1 id="goals">Goals</h1>

<ul>
  <li>Permit users to authenticate when the server is offline</li>
  <li>Encrypt the local storage and the temporary cached data to protect user’s privacy</li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>Offline storage is still a challenging subject for mobile development, because it’s a wild environment where developers don’t have any control over it. Users can have their devices stolen, borrowed by someone or infected with whatever kind of malware is available. There is no magic, most part of the time you can just hope for the best and try to conciliate security and usability.</p>

<p>The <a href="https://issues.jboss.org/browse/AGSEC-156?jql=fixVersion%20%3D%20%221.3.0%22%20AND%20project%20%3D%20AGSEC">previous release</a> our major concern was to create the bare minimum of code needed for future growth. This documentation will discuss: caching and offline storage, how to protect both and some possibilities for data sync.</p>

<h2 id="caching">Caching</h2>

<p>Temporally store information like documents, images or presentations — sometimes is required to improve the user experience. That doesn’t mean they are less significant or critical, we never know which kind of file will be there.</p>

<p>By default we chose <a href="http://en.wikipedia.org/wiki/Cache_algorithms#Least_Recently_Used">LRU (<em>Least Recently Used</em>)</a> as our caching mechanism. Based on the state of data that have been used recently. The API knows that most frequent used data will probably be used again in the future.</p>

<h3 id="policy">Policy</h3>

<p>The API will attempt to retrieve data from the cache — if of course, data was previously cached — otherwise, a request is sent to the remote resource. All the cached resources stay in memory while the application is opened. Once the application is closed, objects in memory must be persisted to the file system.</p>

<p><img src="http://photon.abstractj.org/cdraw_429439_pixels_20140505_115014_20140505_115017.jpg" alt="" /></p>

<p>Each and every idea will be evaluated to make sure that it works in every platform, including: iOS, Android and JavaScript.</p>

<h3 id="configuration">Configuration</h3>

<p>The initial configuration will come in two flavors combined for better performance: memory (faster) and disk (slowly). Developers will be allowed to choose, although by default it will come like was described at policy section.</p>

<h3 id="implementation-details">Implementation details</h3>

<p>Each platform has its own specific implementation details. All we can do is our best to keep the symmetry between APIs, but behind the scenes is almost impossible to have identical technical details.</p>

<h4 id="android">Android</h4>

<p>Android already implements its own <a href="http://developer.android.com/reference/android/util/LruCache.html">LruCache</a>. The missing bits are related with the caching policy and testing to make sure that performance won’t be a problem.</p>

<p>A PoC to validate some concepts was created: <a href="https://github.com/danielpassos/aerogear-android-offline">AeroGear Android Offline</a> and <a href="https://github.com/danielpassos/aerogear-android-offline-demo">AeroGear Android Offline Demo</a>.</p>

<ul>
  <li>
    <p>Related Jiras:</p>

    <ul>
      <li><a href="https://issues.jboss.org/browse/AGDROID-238">AGDROID-238</a></li>
    </ul>
  </li>
</ul>

<h4 id="api-overview">API overview</h4>

<ul>
  <li>
    <p>CacheManager: A factory and provider for different cache implementations.</p>
  </li>
  <li>
    <p>Cache: Interface for multiple caching support like memory and disk.</p>
  </li>
  <li>
    <p>CacheTypes: Enum types with values MEMORY and DISK.</p>
  </li>
  <li>
    <p>CacheConfig: Caching configuration parameters like size, type and encryption</p>
  </li>
</ul>

<h4 id="how-to-use-it">How to use it</h4>

<h5 id="creating">Creating</h5>

<p>Developers can implement their own <em>caching configuration</em> strategy if they want to. This way users are free to choose whatever library best fits
their needs.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class MyCacheConfig extends CacheConfig&lt;MyCacheConfig&gt; {
    public &lt;K, V&gt; MyCrazyCache&lt;K, V&gt; createMyCrazyCache() {
        return new MyCrazyCache&lt;String, URL&gt;()
    }
}
</code></pre></div></div>

<p>Otherwise, people just willing to cache their resources can stick with defaults.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CacheManager cacheManager = new CacheManager();

//Internally instantiates a default cache config in Memory
Cache&lt;String, File&gt; cache = cacheManager.cache("fileMemoryCache");

cache.init(new Callback&lt;Cache&gt;() {
    @Override
    public void onSuccess(Cache cache) {
        //do something amazing
    }

    @Override
    public void onFailure(Exception e) {
        //name the names responsible for this
    }
});
</code></pre></div></div>

<p>Or specify some of the caching types already existent.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//Inform an specific caching configuration
CacheConfig cacheConfig = new CacheConfig(CacheTypes.MEMORY);

Cache&lt;String, File&gt; cache = cacheManager.cache("fileMemoryCache", cacheConfig);

cache.init(new Callback&lt;Cache&gt;() {
    @Override
    public void onSuccess(Cache cache) {
        //do something amazing
    }

    @Override
    public void onFailure(Exception e) {
        //name the names responsible for this
    }
});
</code></pre></div></div>

<h5 id="caching-1">Caching</h5>

<p>Include a new file is supposed to be dead simple, just invoke <em>put</em> to save or update the data with <em>key</em> name and <em>file</em> as argument. Behind the scenes file will be added to the cache previously initialized.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>File file = //some file coming from Universe
cache.put(fileDownloaded.getName(), fileDownloaded);
</code></pre></div></div>

<h5 id="retrieval">Retrieval</h5>

<p>Before sending any requests to the server, might be interesting to check if the data already exists locally. This method allows to retrieve the data based on the <em>key</em> provided.</p>

<p><strong>Note</strong>: Maybe for the next releases we could implement some additional policies like automatically check the cache before sending requests to the server.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>myCache.get(fileDownloaded.getName());
</code></pre></div></div>

<h5 id="removing">Removing</h5>

<p>The removal of local cache on logout is not planned for this release, but is possible to include on the list of policies for further release. The current API allows developers to purge objects from disk, once the equivalent <em>key</em> is provided.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>myCache.remove(fileDownloaded.getName());
</code></pre></div></div>

<h4 id="ios">iOS</h4>

<h5 id="tbd">TBD</h5>

<ul>
  <li>Some ideas from Christos
    <ul>
      <li>Core data plus the implementation of adapters for Memory and Disk.</li>
    </ul>
  </li>
</ul>

<h4 id="javascript">JavaScript</h4>

<h5 id="appcache-or-server">AppCache or Server</h5>

<p>JavaScript is a completely different environment from native platforms. Implementing caching on the client side would be silly since solutions for caching have existed for years. Developers willing to cache data with JavaScript, must stick with Server Caching or AppCache — even if it’s <a href="http://alistapart.com/article/application-cache-is-a-douchebag">a douchebag</a>.</p>

<h2 id="encrypted-storage">Encrypted Storage</h2>

<p>The API must allow the local storage to be self-encrypted, by that we mean once <strong>KeyStore/KeyChain</strong> is opened, any data inserted was supposed to be properly encrypted.</p>

<h2 id="offline-storage">Offline storage</h2>

<p>AeroGear already comes with several options for offline storage, thankfully to our team. Here comes some options:</p>

<ul>
  <li>Android: Memory, SQLite</li>
  <li>iOS: Memory, SQLite</li>
  <li>JavaScript: Memory, Session Local, Indexed DB and WebSQL</li>
</ul>

<p>All the storage mechanisms already support password-based encryption with <em>AES-GCM</em>.</p>

<h2 id="offline-authentication">Offline Authentication</h2>

<p>Server-side authentication is easy compared to offline, because we don’t need to worry about how passwords will be kept on the server (from the client- side perspective). When the device goes offline some critical problem will emerge like users will lose their access to the application, sensitive data being exposed to attackers or data loss.</p>

<p>On the bright side the solution in theory is simple at first glance. The application requests users to provide their
credentials the first time the application is started, but the password <strong>can’t</strong> be kept on device. That would represent a risk if device is stolen, lost, borrowed or infected with malware.</p>

<p>The proposed solution is to make use of cryptographic functions in an attempt to slow down an adversary in case the user’s device is compromised.</p>

<h3 id="password-registration">Password registration</h3>

<p><img src="http://photon.abstractj.org/cdraw_368448_pixels_20140502_162611_20140502_162614.jpg" alt="" /></p>

<h3 id="offline-authentication-1">Offline authentication</h3>

<p><img src="http://photon.abstractj.org/cdraw_284352_pixels_20140502_163240_20140502_163242.jpg" alt="" /></p>

<h2 id="data-encryption">Data encryption</h2>

<h3 id="storage">Storage</h3>

<p><img src="http://photon.abstractj.org/cdraw_343526_pixels_20140502_163918_20140502_163920.jpg" alt="" /></p>

<h3 id="remote-storage">Remote storage</h3>

<p>If the data must be stored in another infrastructure, the server should never have access to user’s data, instead, the application must send the data encrypted as well the public keys for data sync. Once some data is added on the server side, it should be encrypted with the public key provided and sent back to the client.</p>

<p><strong>Note:</strong> To not lose our focus here, <em>offline storage</em>, anything related with <em>data sync</em> will be proposed in a separated document</p>

<h2 id="api-symmetry">API symmetry</h2>

<h3 id="android-1">Android</h3>

<p>The Android platform make use of <a href="https://github.com/aerogear/aerogear-crypto-java">AeroGear Crypto</a> plus the <a href="https://github.com/aerogear/aerogear-android/blob/247009a1a729952bae964e34551c7cb92846a132/src/org/jboss/aerogear/android/impl/security/PasswordEncryptionServices.java#L74">support added for the KeyStore management</a>  AeroGear Android providing an easy to use functionality to extract the private and public key.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KeyManager keyManager = new KeyManager();
PasswordProtectedKeystoreCryptoConfig keystoreCryptoConfig = new PasswordProtectedKeystoreCryptoConfig();
keystoreCryptoConfig.setAlias("offline");

//Derive the password with a KDF function
keystoreCryptoConfig.setPassword(password.getText().toString());
try {
      EncryptionService encryptionService = keyManager.encryptionService("key", keystoreCryptoConfig,
            LoginActivity.this);
        startActivity(new Intent(LoginActivity.this, DocumentsActivity.class));
} catch (RuntimeException e) {
        Toast.makeText(LoginActivity.this, e.getMessage(), Toast.LENGTH_LONG).show();
}
</code></pre></div></div>

<h3 id="javascript-1">JavaScript</h3>

<ul>
  <li>It must be discussed, about how the encrypted cache should work in scenarios where passwords are not provided.
TBD</li>
</ul>

<h3 id="ios-1">iOS</h3>

<p>The iOS platform will make use of <a href="https://github.com/aerogear/aerogear-crypto-ios">AeroGear Crypto iOS</a> library for the generation of public/private keys and encryption. Further, since the Keychain in iOS can be compromised, the key pairs generated would be further encrypted using the key generated by the KDF passphrase and stored using an appropriate protection class (<em>kSecAttrAccessibleWhenUnlockedThisDeviceOnly</em>).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AGKeyManager *keyManager = [AGKeyManager manager];

AGPasswordProtectedKeychainCryptoConfig *keychainCryptoConfig = [[AGPasswordProtectedKeychainCryptoConfig alloc] init];
[keychainCryptoConfig setAlias:@"offline"];

//Derive the password with a KDF function
[keychainCryptoConfig setPassword:password.text];

 // initialize the encryption service passing the config
id&lt;AGEncryptionService&gt; encryptionService = [keyManager encryptionService:keychainCryptoConfig];
</code></pre></div></div>

<p>For caching functionalities, research the feasibility of using <a href="https://github.com/gnustep/gnustep-base/blob/master/Source/NSCache.m#L195">NSCache</a></p>

<h2 id="demo-application">Demo application</h2>

<ul>
  <li>https://github.com/danielpassos/aerogear-offline-android-demo/</li>
</ul>

<h2 id="planned-jiras">Planned Jiras</h2>

<h3 id="offline-storage-1">Offline Storage</h3>
<p>component: offline, crypto, storage</p>

<ul>
  <li>AGSEC-XXX: Queries on encrypted database</li>
</ul>

<p><em>Description</em>: Currently for the local storage we encrypt and decrypt the whole database, which makes the solution impractical in scenarios where 1GB of data is provided</p>

<ul>
  <li>AGSEC-XXX: Key management based on device unlock</li>
</ul>

<p><em>Description</em>: Investigate if is possible to derive the key based on device unlock or PIN</p>

<h3 id="encrypted-cache">Encrypted Cache</h3>
<p>component: offline, crypto, cache</p>

<ul>
  <li>AGSEC-XXX: R&amp;D about LRU</li>
</ul>

<p><em>Description</em>: Currently is necessary to investigate better if LRU is the best politic for JS, iOS and Android for the sake of API symmetry</p>

<ul>
  <li>AGSEC-XXX: Add data caching support for mobile devices</li>
</ul>

<p><em>Description</em>: Allow developers to choose when they want to cache the data</p>

<ul>
  <li>AGSEC-XXX: Add cache encryption support for mobile devices</li>
</ul>

<p><em>Description</em>: Allow developers to choose when they want their cache encrypted</p>

<h3 id="remote-storage-1">Remote Storage</h3>
<p>component: crypto, sync</p>

<ul>
  <li>AGSEC-XXX: Device registration</li>
</ul>

<p><em>Description</em>: Device registration and management on the server side</p>

<ul>
  <li>AGSEC-XXX: Revoke capability</li>
</ul>

<p><em>Description</em>: Adds the ability to revoke the key stored on device using another authorized device</p>

<ul>
  <li>AGSEC-XXX: Remote wipe a mobile device</li>
</ul>

<p><em>Description</em>: Removal of the data when the user is online including offline storage and cache</p>

<ul>
  <li>AGSEC-XXX: Add Public Key to Remote Server</li>
</ul>

<p><em>Description</em>: Send the public key to the server. The key provided will be used to encrypt data and verify digital signatures. Ex. Thinking about data sync when user include a record the server should be able to encrypt the data with the user’s public key and sent it back to the device.</p>

<ul>
  <li>AGSEC-XXX: Public key authentication</li>
</ul>

<p><em>Description</em>: As an additional level of security each user will have her own digital signature to provide authentication and data integrity, ensuring that the origin is legit. Pretty similar to the SSH scheme, but we want to keep the password into this situation.</p>

<h1 id="next-steps">Next steps</h1>

<ul>
  <li>This document is something completely under development, but before we move forward would be nice some feedback to guarantee that everyone is on the same page.</li>
  <li>File Jiras</li>
  <li>Implement it :)</li>
</ul>

      
      </div><!-- col 8 -->
    </div><!-- row -->
  </div><!-- container -->
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-sm-3">
        <h5>Getting Started</h5>
        <ul class="list-unstyled">
          <li><a href="/getting-started/overview/">Overview</a></li>
          <li><a href="/getting-started/installation-and-configuration/">Installation &amp; Configuration</a></li>
          <li><a href="/getting-started/creating-mobile-apps/">Creating Mobile Apps</a></li>
          <li><a href="/getting-started/enabling-mobile-services/">Enabling Mobile Services</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile Services</h5>
        <ul class="list-unstyled">
         <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
         <li><a href="/services/push/">Push Notifications</a></li>
         <li><a href="/services/metrics/">Metrics</a></li>
         <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
         <li><a href="/services/identity-management/">Identity Management</a></li>
         <li><a href="/services/device-security/">Device Security</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile SDKs</h5>
        <ul class="list-unstyled">
         <li><a href="/sdks/android/">Android</a></li>
         <li><a href="/sdks/cordova/">Cordova</li>
         <li><a href="/sdks/ios/">iOS</a></li>
         <li><a href="/sdks/xamarin/">Xamarin</a></li>
        </ul>
      </div><!-- col -->
      
      <div class="col-sm-3">
        <h5>COMMUNITY</h5>
        <ul class="list-unstyled">
          <li><a target="_blank" href="https://github.com/aerogear/">GitHub - Aerogear</a></li>
          <li><a target="_blank" href="https://github.com/aerogearcatalog/">GitHub - Aerogear Catalog</a></li>
          <li><a target="_blank" href="https://issues.jboss.org/browse/AEROGEAR">Jira Repo Issues</a></li>
          <li><a  href="/community/contribution-guide/">Contribution Guide</a></li>
          <li><a target="_blank" href="https://groups.google.com/forum/#!forum/aerogear">Google Group</a></li>
          <li><a href="irc://irc.freenode.net/aerogear">IRC</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-12 follow">
        <h5>FOLLOW US</h5>
        <ul class="list-inline">
          <li><a target="_blank" href="https://www.twitter.com/aerogears"><i class="fa fa-twitter-square"></i> Twitter</a></li>
          <li><a target="_blank" href="https://www.facebook.com/AeroGearProject"><i class="fa fa-facebook-square"></i> Facebook</a></li>
          <li><a target="_blank" href="https://plus.google.com/106588661437153585722/posts"><i class="fa fa-google-plus-square"></i> Google+</a></li>
          <li><a target="_blank" href="/feed.atom"><i class="fa fa-rss-square"></i> Feed</a></li>
        </ul>
        
        <p>AeroGear project is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a></p>
      </div><!-- col -->
    
    </div><!-- row -->

  </div><!-- container -->

</footer><!-- footer -->

<section class="redhat">
  <div class="container">
    <p class="text-center">
      <a href="http://www.redhat.com/">
        <img src="/img/redhatlogo-wite.png" alt="redhatlogo-wite" width="130">
      </a>
    </p>       
  </div><!-- container -->
</section>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!-- <script src="/bower_components/jquery/dist/jquery.min.js"></script> -->

<!-- Include all compiled plugins (below), or include individual files as needed  -->  
<script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- My script -->
<script src="/js/script.js"></script>

</body>
</html>