<!doctype html>
<html>
<head>
  <title>AeroGear - FCM Push Notifications with AeroGear's UnifiedPush Server</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Main styles-->
  <link href="/css/styles.css" rel="stylesheet" media="screen">

  <!-- Syntax highlighting -->
  <link href="/css/syntax.css" rel="stylesheet"> 

  <!-- Icons -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/css/openshift-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>


  <!-- google analytics -->
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28733717-2']);
      _gaq.push(['_setDomainName', 'aerogear.org']);
      _gaq.push(['_trackPageview']);

      (function () {
          var ga = document.createElement('script');
          ga.type = 'text/javascript';
          ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
  </script>
  

</head>

<body>    

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">AeroGear</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        

        <li class="">
          <a href="/">Home</a>
        </li>

        <li class="">
          <a href="/getting-started/overview/">Getting Started</a>
        </li>


        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile Services<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
              <li><a href="/services/push/">Push Notifications</a></li>
              <li><a href="/services/metrics/">Metrics</a></li>
              <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
              <li><a href="/services/identity-management/">Identity Management</a></li>
              <li><a href="/services/device-security/">Device Security</a></li>
            </ul>
        </li>

        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile SDKs<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/sdks/android/">Android</a></li>
            <li><a href="/sdks/cordova/">Cordova</li>
            <li><a href="/sdks/ios/">iOS</a></li>
            <li><a href="/sdks/xamarin/">Xamarin</a></li>
          </ul>
        </li>

        <li class="hidden-sm ">
          <a href="https://docs.aerogear.org">Docs</a>
        </li>
   
        
        <li class="">
          <a href="/community">Community</a>
        </li>
        

        <li class="">
          <a href="/news">News</a>
        </li>
        
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<section class="main-banner">
  <div class="container">
    
  <h2>Aerogear Guides <small>Tutorials to help get you off and running.</small></h2>

  </div><!-- container -->
</section> <!-- main banner -->


<section class="guides">
  
  <div class="container">
         <ol class="breadcrumb" style="margin:0">
      <li>
        
          <a href="/getstarted/guides/">Guides</a>
        
      </li>
      <li class="active">FCM Push Notifications with AeroGear's UnifiedPush Server</li>
    </ol>
  </div><!-- container -->


  <div class="container">
    <div class="row">
      
      <div class="col-md-3 hidden-sm hidden-xs sidebar">
        <ul class="nav">
   <li class="toc_level-1 toc_section-1">
      <a href="#google-setup">
         <span class="toctext">Obtaining Firebase Cloud Messaging Credentials</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-2">
            <a href="#_project_setup_and_app_registration_using_the_firebase_console">
               <span class="toctext">Project Setup and App Registration using the Firebase Console</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-3">
      <a href="#register-device">
         <span class="toctext">The AeroGear UnifiedPush Server</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-4">
            <a href="#_android_studio">
               <span class="toctext">Android Studio</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-5">
      <a href="#android-app">
         <span class="toctext">Your first Android/Push App</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-6">
            <a href="#_creating_the_application">
               <span class="toctext">Creating the application</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-7">
            <a href="#_registration_with_the_unifiedpush_server">
               <span class="toctext">Registration with the UnifiedPush server</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-8">
            <a href="#_receiving_notifications">
               <span class="toctext">Receiving notifications</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-9">
            <a href="#_metrics">
               <span class="toctext">Metrics</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-10">
      <a href="#push-notification">
         <span class="toctext">Send a Push Notification</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-11">
            <a href="#_simple_sender">
               <span class="toctext">Simple Sender</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-12">
            <a href="#_you_are_done">
               <span class="toctext">You are done</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-13">
            <a href="#_last_minute_notes">
               <span class="toctext">Last-Minute Notes</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-14">
      <a href="#troubleshooting">
         <span class="toctext">Android Troubleshooting</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-15">
            <a href="#_issue_registration_fails_with_the_error_service_not_available">
               <span class="toctext">Issue: Registration fails with the error "SERVICE_NOT_AVAILABLE"</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-16">
            <a href="#_issue_registration_fails_with_invalid_sender">
               <span class="toctext">Issue: Registration fails with INVALID_SENDER</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-17">
            <a href="#_i_have_another_issue">
               <span class="toctext">I have another Issue</span>
            </a>
         </li>
      </ul>
   </li>
</ul>
      </div><!-- col -->
      
      <div class="col-md-9 post">
      
        <h1>FCM Push Notifications with AeroGear's UnifiedPush Server</h1>
        <div class="paragraph">
<p>The following step-by-step guides, give you an introduction on how to use the AeroGear UnifiedPush Server for sending Push Notifications to your own Android Apps. You will need a Google account to use Firebase services, and can use either a real Android device or the emulator to test. So, letâ€™s get started:</p>
</div>
<div class="sect1">
<h2 id="google-setup">Obtaining Firebase Cloud Messaging Credentials</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before the Android application is able to receive the notifications, you must set up access to Firebase Cloud Messaging. Luckily, this is both easy and free to do, and does not require much setup. As with iOS, you are only able to test out your push notifications in a real device. This section shows you how to obtain the credentials necessary to set up Firebase Cloud Messaging for your app, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <strong>Server key</strong></p>
</li>
<li>
<p>the <strong>Sender ID</strong></p>
</li>
<li>
<p>the <code>google-services.json</code> file containing the credentials required to connect your app to Firebase and Google services.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_project_setup_and_app_registration_using_the_firebase_console">Project Setup and App Registration using the Firebase Console</h3>
<div class="paragraph">
<p>First, register with the Firebase Cloud Messaging (FCM) platform, formerly known as Google Cloud Messaging (GCM). You need a Google Account to do this. Start by opening the <a href="https://console.firebase.google.com">Firebase Console</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you haven&#8217;t created a project, click <strong>Create New Project</strong>:</p>
<div class="paragraph">
<p><span class="image"><img src="../img/create_new_project.png" alt="Create New Project"></span></p>
</div>
</li>
<li>
<p>Now give your new project a name:</p>
<div class="paragraph">
<p><span class="image"><img src="../img/project_name.png" alt="New Project Name"></span></p>
</div>
</li>
<li>
<p>Once the project has been created you will be taken to the <em>Overview</em> screen. From there click the Settings icon located next to the project name in the sidebar, and in the pop-up menu click <strong>Project Settings</strong>.</p>
<div class="paragraph">
<p><span class="image"><img src="../img/project_settings.png" alt="Project Number"></span></p>
</div>
</li>
<li>
<p>On the <em>Project Settings</em> screen, switch to the <em>Cloud Messaging</em> tab, where you can find the <strong>Server key</strong> and <strong>Sender ID</strong> (known in GCM as <strong>Project Number</strong>).</p>
<div class="paragraph">
<p><span class="image"><img src="../img/retrieve_credentials.png" alt="Retrieve Credentials"></span></p>
</div>
</li>
<li>
<p>As the final step of the setup procedure, you need to download the <code>google-services.json</code> file. To do this, first navigate to the <em>Overview</em> screen and click on <strong>Add App</strong> (If you have no apps connected to FCM yet, select the option to <strong>Add Firebase to your Android app</strong>).</p>
<div class="paragraph">
<p><span class="image"><img src="../img/add_app.png" alt="Add Firebase to your app"></span></p>
</div>
</li>
<li>
<p>In the pop-up window enter the Package name of your app and then click the <strong>Add app</strong> button. This generates the <code>google-services.json</code> file that needs to be built into your app binary. Download the JSON file and save it. To close the pop-up window, click <strong>Continue</strong> and then <strong>Finish</strong> on the following screen.</p>
<div class="paragraph">
<p><span class="image"><img src="../img/download_json.png" alt="Download google-services.json"></span></p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To re-download the <code>google-services.json</code> file, navigate to the <em>Project Settings</em> screen, then switch to the <em>General</em> tab, choose the desired app and click the <code>google-services.json</code> download button.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that Google is ready to accept and deliver our messages, we are ready to setup the <a href="#register-device">UnifiedPush server</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="register-device">The AeroGear UnifiedPush Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With all the Google work being done, we are now ready to setup the <a href="https://github.com/aerogear/aerogear-unified-push-server">UnifiedPush Server</a>, so that it can be used to connect to FCM for later message sending.</p>
</div>
<div class="paragraph">
<p>In the <a href="/docs/unifiedpush/ups_userguide/index/#_the_wizard">Wizard</a> after you create a PushApplication, click the <strong>Add Variant</strong> button and fill out the Android options. You will want to use the <strong>Server Key</strong> and <strong>Sender ID</strong> obtained from the <strong>Firebase Console</strong> in their appropriate fields:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/variant_01.png" alt="Android Variant Options"></span></p>
</div>
<div class="paragraph">
<p>Afterwards you will see some code snippets, containing the <strong>Variant ID</strong> and <strong>Secret</strong>, that you can use in your Android application for the registration of the device, running your app:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/variant_02.png" alt="Android Variant Details"></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Clicking on the appropriate tab, you can choose between <em>Android</em> and <em>Cordova</em> snippet!
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_android_studio">Android Studio</h3>
<div class="paragraph">
<p>The server is now configured. Let&#8217;s move to Android Studio and <a href="#android-app">create an Android application</a> that will use the AeroGear Android library to connect to the UnifiedPush server and start receiving notifications.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="android-app">Your first Android/Push App</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that the UnifiedPush server is up and running, time to create a sample application that will exercise AeroGear&#8217;s Android Push library support. For the purpose of the guide we will use the <a href="http://developer.android.com/tools/studio/index.html">Android Studio</a> with the ADT tools installed, but you are free to use any IDE that includes Android Gradle support.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s get started!</p>
</div>
<div class="sect2">
<h3 id="_creating_the_application">Creating the application</h3>
<div class="paragraph">
<p>Fire up Android Studio IDE and choose 'Start a new Android Studio project'. Fill the 'Application Name' field with the name 'PushApplication' and the 'Package Name' with <code>com.push.pushapplication</code>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/android-studio-wizard-1.png" alt="Android Studio - New Project" width="Wizard (Step 1)"></span></p>
</div>
<div class="paragraph">
<p>The <em>Minimum SDK</em> option for the <a href="http://http://github.com/aerogear/aerogear-android-push">AeroGear Android Push</a> &gt;= 2.0 is <em>API 16 (Android 4.1 - Jelly Bean)</em> so select this option if not selected.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/android-studio-wizard-2.png" alt="Android Studio - New Project" width="Wizard (Step 2)"></span></p>
</div>
<div class="paragraph">
<p>Continue through the wizard by accepting the default options presented. Once finished, Android Studio would have generated a sample Android project with a default 'MainActivity' and the layout file for further editing.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/android-studio-project-overview.png" alt="Android Studio - Project Overview"></span></p>
</div>
<div class="paragraph">
<p>We will use the <em>TextView</em> component that the wizard conveniently created for us to display the message payload. But in order to be able to be referenced in our code we need to give the component first an 'id'. Simple append in the 'TextView' declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;TextView
	android:id="@+id/label"
	...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start code, let&#8217;s add the AeroGear Android Push library as a dependency</p>
</div>
<div class="paragraph">
<p>Open the <code>build.gradle</code> app file and add the AeroGear Android Push dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>dependencies {
    ...
    compile 'org.jboss.aerogear:aerogear-android-push:4.+'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have the project set up, time to configure it to receive Push notifications. We will start first with the registration of the application with the UnifiedPush server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_registration_with_the_unifiedpush_server">Registration with the UnifiedPush server</h3>
<div class="paragraph">
<p>First of all, you need create a file <code>push-config.json</code> in <code>app/src/main/assets</code> folder with the Unified Push Informations</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ensure that you put valid values on those params, otherwise you would be unable to register and receive notifications from the UnifiedPush server. Invalid configuration params are a very common source of problems, so please revisit them if you are experiencing problems.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "pushServerURL": "pushServerURL (e.g http(s)//host:port/context)",
  "android": {
    "senderID": "senderID (e.g Google Project ID only for android)",
    "variantID": "variantID (e.g. 1234456-234320)",
    "variantSecret": "variantSecret (e.g. 1234456-234320)"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The entry point for registration is the <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/RegistrarManager.html">RegistrarManager</a>. This is a <em>factory</em> of different implementations of the <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/PushRegistrar.html">PushRegistrar</a> interface which contain the actual registration/unregistration methods.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the method will return an implementation that supports registration with the UnifiedPush server. Having the flexibility of a factory method, allows us in the future to expand it to support other different message brokers under a common messaging interface.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since the registration setup is an one-step process not bound to any Android 'Activity', let&#8217;s encapsulate it in a subclass of an Android <a href="http://developer.android.com/reference/android/app/Application.html">Application</a>.</p>
</div>
<div class="paragraph">
<p>Create a new class, name it <code>PushApplication</code> and paste the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.push.pushapplication;

import android.app.Application;

import org.jboss.aerogear.android.unifiedpush.PushRegistrar;
import org.jboss.aerogear.android.unifiedpush.RegistrarManager;
import org.jboss.aerogear.android.unifiedpush.fcm.AeroGearFCMPushJsonConfiguration;

public class PushApplication extends Application {

    private static final String PUSH_REGISTAR_NAME = "myPushRegistar";

    @Override
    public void onCreate() {
        super.onCreate();

        RegistrarManager.config(PUSH_REGISTAR_NAME, AeroGearFCMPushJsonConfiguration.class)
                .loadConfigJson(getApplicationContext())
                .asRegistrar();

    }

    // Accessor method for Activities to access the 'PushRegistrar' object
    public PushRegistrar getPushRegistar() {
        return RegistrarManager.getRegistrar(PUSH_REGISTAR_NAME);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setup of the registration happens on the <code>onCreate</code> lifecycle method called when Android first initializes your application. It will create (and store) a <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/PushRegistrar.html">PushRegistrar</a> object based on <code>push-config.json</code> informations declared earlier. This object together with a name (it can be anything you choose) are passed as params on the <code>config</code> factory method to create the <code><a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/PushRegistrar.html">PushRegistrar</a></code> object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t forget to configure the <a href="http://developer.android.com/reference/android/app/Application.html">Application</a> class in <code>AndroidManifest.xml</code>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;application
    android:name=".PushApplication"
    ...
/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now ready to call <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/PushRegistrar.html#register">PushRegistrar:register</a> method to register our device in the UnifiedPush server. Switch to the <code>MainActivity</code> class and replace the existing <code>onCreate</code> method with the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    PushApplication application = (PushApplication) getApplication();
    PushRegistrar pushRegistar = application.getPushRegistar();
    pushRegistar.register(getApplicationContext(), new Callback&lt;Void&gt;() {
        @Override
        public void onSuccess(Void data) {
            Log.d(TAG, "Registration Succeeded");
            Toast.makeText(getApplicationContext(),
                    "Yay, Device registered", Toast.LENGTH_LONG).show();
        }

        @Override
        public void onFailure(Exception e) {
            Log.e(TAG, e.getMessage(), e);
            Toast.makeText(getApplicationContext(),
                    "Ops, something is wrong :(", Toast.LENGTH_LONG).show();
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is all what is needed to register with the UnifiedPush server!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
That we didn&#8217;t have to write any code to register the device with FCM. The library takes care off all the plumbing to register the device with FCM, obtain the <code>registrationId</code> and submit it to the UnifiedPush server.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/app-main-screen.png" alt="Push Application - Main Screen">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t see the <em>Registration Succeeded</em> popup, means that an error has occurred during the registration. Switch to the LogCat console in Android Studio to locate the exception and act accordingly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_receiving_notifications">Receiving notifications</h3>
<div class="paragraph">
<p>The standard practice for an Android application to be able to receive notifications, is the developer to edit App&#8217;s manifest to enable the appropriate FCM permissions and also implement an <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">Android BroadcastReceiver</a> that is called when a new notification arrives. Typically the receiver includes code that consumes the message and displays the payload in the Notification Manager. AeroGear library already provides an implementation of a broadcast receiver that a developer can use, <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/fcm/AeroGearFCMMessageReceiver.html">AeroGearFCMMessageReceiver</a>, but instead of displaying in the notification manager it delegates the consumption of the message to those that have expressed interest.</p>
</div>
<div class="paragraph">
<p>A developer implements the <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/MessageHandler.html">MessageHandler</a> interface and registers it with the library in order to be called when a new notification arrives. You can have multiple components listening for incoming notifications and the library will call each one in tandem upon arrival. To register a component, simple call the <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/RegistrarManager.html#registerMainThreadHandler-org.jboss.aerogear.android.unifiedpush.MessageHandler-">RegistrarManager:registerMainThreadHandler</a> method if you want your component to be called on the main thread or <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/RegistrarManager.html#registerBackgroundThreadHandler-org.jboss.aerogear.android.unifiedpush.MessageHandler-">Registrations:registerBackgroundThreadHandler</a> method if you want to be called on a background thread. In the absence of any registered listeners, the library will call a default <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/MessageHandler.html">MessageHandler</a> that you have defined in your app&#8217;s manifest.</p>
</div>
<div class="paragraph">
<p>Typically you register a <em>default</em> <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/MessageHandler.html">MessageHandler</a> that displays the notification in the NotificationManager when your application is stopped or in the background and possible a <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/MessageHandler.html">MessageHandler</a> that consumes the payload when your application is active.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Nothing prevents you to send a notification in the Notification Manager when your application is active; the mechanism is there for your convenience.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s return to our example. We are going to register a default <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/MessageHandler.html">MessageHandler</a> that will display the received notification and show in the Notification Manager. First we need to edit the app&#8217;s manifest.</p>
</div>
<div class="sect3">
<h4 id="_configuring_app_s_manifest">Configuring App&#8217;s manifest</h4>
<div class="paragraph">
<p>Open the <code>AndroidManifest.xml</code> file and below the <code>&lt;manifest&gt;</code> entry add the necessary permissions to enable our app to receive messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;manifest
....
   &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
   &lt;uses-permission android:name="android.permission.GET_ACCOUNTS" /&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s register now our own <code>MessageHandler</code> inside of the <code>&lt;application&gt;</code> entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;application
...
    &lt;meta-data android:name="DEFAULT_MESSAGE_HANDLER_KEY" android:value="com.push.pushapplication.NotifyingHandler"/&gt;
&lt;/application&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice the <code>DEFAULT_MESSAGE_HANDLER_KEY</code> parameter is used to pass the name of the default MessageHandler class that will be called once the notification is received.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_handling_notification">Handling notification</h4>
<div class="paragraph">
<p>Create a new class, name it <code>NotifyingHandler</code> and paste the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.push.pushapplication;

import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.media.RingtoneManager;
import android.os.Bundle;
import android.support.v4.app.NotificationCompat;

import org.jboss.aerogear.android.unifiedpush.MessageHandler;
import org.jboss.aerogear.android.unifiedpush.fcm.UnifiedPushMessage;

public class NotifyingHandler implements MessageHandler {

    public static final int NOTIFICATION_ID = 1;
    private Context context;

    public static final NotifyingHandler instance = new NotifyingHandler();

    public NotifyingHandler() {
    }

		@Override
    public void onMessage(Context context, Bundle bundle) {
        this.context = context;

        String message = bundle.getString(UnifiedPushMessage.ALERT_KEY);

        HelloWorldApplication application = (HelloWorldApplication) context.getApplicationContext();
        application.addMessage(message);

        notify(bundle);
    }

    private void notify(Bundle bundle) {

        NotificationManager mNotificationManager = (NotificationManager)
                context.getSystemService(Context.NOTIFICATION_SERVICE);

        String message = bundle.getString(UnifiedPushMessage.ALERT_KEY);

        Intent intent = new Intent(context, MainActivity.class)
                .addFlags(PendingIntent.FLAG_UPDATE_CURRENT)
                .putExtra(UnifiedPushMessage.ALERT_KEY, message);

        PendingIntent contentIntent = PendingIntent.getActivity(context, 0, intent,
                PendingIntent.FLAG_UPDATE_CURRENT);

        NotificationCompat.Builder mBuilder = new NotificationCompat.Builder(context)
                .setAutoCancel(true)
                .setSmallIcon(R.mipmap.ic_launcher)
                .setContentTitle(context.getString(R.string.app_name))
                .setStyle(new NotificationCompat.BigTextStyle().bigText(message))
                .setSound(RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION))
                .setContentText(message);

        mBuilder.setContentIntent(contentIntent);
        mNotificationManager.notify(NOTIFICATION_ID, mBuilder.build());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>AeroGear calls the <code>onMessage</code> callback method when a new notification arrives. Here we simply extract the message payload and we use the platform&#8217;s notification manager to display it.</p>
</div>
<div class="paragraph">
<p>Since we also want the <code>MainActivity</code> to be able to receive the notification and update the TextView with the payload, we need to register it with the library. To do so the Activity, as with the <code>NotifyingHandler</code> class we saw earlier, must implement the <a href="/docs/specs/aerogear-android-push/org/jboss/aerogear/android/unifiedpush/MessageHandler.html">MessageHandler</a> interface. In the declaration of the Activity simple append the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MainActivity extends Activity implements MessageHandler {</code></pre>
</div>
</div>
<div class="paragraph">
<p>and paste the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
protected void onResume() {
    super.onResume();
    RegistrarManager.registerMainThreadHandler(this); // 1
    RegistrarManager.unregisterBackgroundThreadHandler(NotifyingHandler.instance);
}

@Override
protected void onPause() {
    super.onPause();
    RegistrarManager.unregisterMainThreadHandler(this); // 2
    RegistrarManager.registerBackgroundThreadHandler(NotifyingHandler.instance);
}

@Override
public void onMessage(Context context, Bundle bundle) {
    // display the message contained in the payload
    TextView text = (TextView) findViewById(R.id.label);
    text.setText(bundle.getString(UnifiedPushMessage.ALERT_KEY)); // 3
}

@Override
public void onDeleteMessage(Context context, Bundle message) {
    // handle GoogleCloudMessaging.MESSAGE_TYPE_DELETED
}

@Override
public void onError() {
    // handle GoogleCloudMessaging.MESSAGE_TYPE_SEND_ERROR
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we use the standard Activity life-cycle methods <code>onResume</code> to register[1] and  <code>onPause</code> to unregister[2] itself for handling the notification. Finally, in the <code>onMessage</code> callback method[3] we simple extract the message payload and update the TextView.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/app-message-received.jpg" alt="Push Application - Message received">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metrics">Metrics</h3>
<div class="paragraph">
<p>Optionally the Android SDK supports sending metrics to UPS. Metrics can be used to view how many users have received/readed/opened the message. This can be important information if you want to know how well your messages are received by your application users.</p>
</div>
<div class="paragraph">
<p>UPS sends an unique ID for every push message by default all we have to do is send this ID back to UPS when the app was opened using the message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
public void onMessage(Context context, Bundle bundle) {
    // Do something with the message
    String message = bundle.getString(UnifiedPushMessage.ALERT_KEY);
    ...

    // Send metrics about the message received
    PushApplication application = (PushApplication) getApplication();
    AeroGearFCMPushRegistrar pushRegistar = (AeroGearFCMPushRegistrar) application.getPushRegistar();

    String pushMessageId = bundle.getString(UnifiedPushMessage.PUSH_MESSAGE_ID);
    UnifiedPushMetricsMessage pushMetricsMessage = new UnifiedPushMetricsMessage(pushMessageId);

    pushRegistar.sendMetrics(pushMetricsMessage, new Callback&lt;UnifiedPushMetricsMessage&gt;() {
        @Override
        public void onSuccess(UnifiedPushMetricsMessage unifiedPushMetricsMessage) {
            Log.d(TAG, "Metrics for : " + unifiedPushMetricsMessage.getMessageId() + " successfully sent");
        }

        @Override
        public void onFailure(Exception e) {
            Log.d(TAG, e.getMessage(), e);
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have our application up an running time to <a href="#push-notification">send messages</a> using the AeroGear UnifiedPush Server!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="push-notification">Send a Push Notification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have the sample application running, it is time to use the <em>AeroGear UnifiedPush Server</em> for delivering a <em>Push Notification</em> message.</p>
</div>
<div class="sect2">
<h3 id="_simple_sender">Simple Sender</h3>
<div class="paragraph">
<p>Log into the administration console of the UnifiedPush server and click on the "Send Notification" button on the desired PushApplication and write a message in the text field. Once done, hit the 'Send Push Notification':</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/send_notification.png" alt="Send Notification"></span></p>
</div>
<div class="paragraph">
<p>If all goes well, you should see the message payload being displayed on screen:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/hello-unifiedpush-active.png" alt="Message Receiced-Active"></span></p>
</div>
<div class="paragraph">
<p>Now click the 'Home' button to return to Android Home Screen and send another push message. You should see the notification being displayed in the Notification Manager:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/hello-unifiedpush-inactive.png" alt="Message Receiced-InActive"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_you_are_done">You are done</h3>
<div class="paragraph">
<p>That&#8217;s all you need to use the <em>AeroGear</em> project for sending and receiving <em>Push Notifications</em> from Android.</p>
</div>
</div>
<div class="sect2">
<h3 id="_last_minute_notes">Last-Minute Notes</h3>
<div class="paragraph">
<p>Since we interface with the Android devices via <a href="https://firebase.google.com/docs/cloud-messaging/">Firebase Cloud Messaging</a>, we still have a few things to keep in mind regarding the messages we send:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Messages can be maximum 4kb</p>
</li>
<li>
<p>Messages can be <a href="http://developer.android.com/google/gcm/adv.html#throttling">throttled</a></p>
</li>
<li>
<p>Google will hold messages in queue for 28 days if the intended device is unavailable for delivery, after which they will be discarded</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a more thorough explanation of the FCM system and queue, check out the <a href="https://firebase.google.com/docs/cloud-messaging/">Firebase Cloud Messaging Documentation</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting">Android Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This troubleshooting guide takes as a pre-requesite that you have carefully followed the instructions in the <a href="../index.html">Android tutotial</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve documented some of the common configuration failures in this guide.  If you are having issues which we don&#8217;t cover or otherwise need help, feel free to post to our link:<a href="https://lists.jboss.org/mailman/listinfo/aerogear-users/">user list</a>.</p>
</div>
<div class="sect2">
<h3 id="_issue_registration_fails_with_the_error_service_not_available">Issue: Registration fails with the error "SERVICE_NOT_AVAILABLE"</h3>
<div class="paragraph">
<p><strong>Problem description</strong></p>
</div>
<div class="paragraph">
<p>When you call <code>PushRegistrar.register</code> onFailure is called with the exception message "SERVICE_NOT_AVAILABLE".</p>
</div>
<div class="paragraph">
<p><strong>Answer</strong></p>
</div>
<div class="paragraph">
<p>There are several causes for this issue.  The easiest solution is that the FCM registration service had an error and you should retry at a later date.  However, there are also several code/environment issues to check.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You do not have Google Play Services installed on your device.<br>
If you are running an emulator, make sure you are using a Google APIs Target higher than Android 4.2. If you are using a device, make sure you are using a Google experience device and not an Amazon Fire or AOSP device.</p>
</li>
<li>
<p>Make sure the <strong>permission</strong> and <strong>uses-permission</strong> tags in AndroidManifest.xml have the correct package.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;permission android:name="YOUR_PACKAGE_NAME.permission.C2D_MESSAGE"
       android:protectionLevel="signature" /&gt;
&lt;uses-permission android:name="YOUR_PACKAGE_NAME.permission.C2D_MESSAGE" /&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure you have the correct permissions available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;uses-permission android:name="android.permission.INTERNET" /&gt;
&lt;uses-permission android:name="android.permission.GET_ACCOUNTS" /&gt;
&lt;uses-permission android:name="android.permission.WAKE_LOCK" /&gt;
&lt;uses-permission android:name="com.google.android.c2dm.permission.RECEIVE" /&gt;

&lt;permission android:name="YOUR_PACKAGE_NAME.permission.C2D_MESSAGE"
       android:protectionLevel="signature" /&gt;
&lt;uses-permission android:name="YOUR_PACKAGE_NAME.permission.C2D_MESSAGE" /&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure your device&#8217;s clock is set correctly.  Some people on <a href="http://stackoverflow.com/questions/17188982/how-to-fix-google-cloud-messaging-registration-error-service-not-available">Stack Overflow</a> have reported this issue.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_issue_registration_fails_with_invalid_sender">Issue: Registration fails with INVALID_SENDER</h3>
<div class="paragraph">
<p><strong>Problem description</strong></p>
</div>
<div class="paragraph">
<p>When you call <code>PushRegistrar.register</code> onFailure is called with the exception message "INVALID_SENDER".</p>
</div>
<div class="paragraph">
<p><strong>Answer</strong></p>
</div>
<div class="paragraph">
<p>Make sure the SenderID matches the project number from the Google API Console.  This will be an <a href="../img/gcc_3.png">all numeric string</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_i_have_another_issue">I have another Issue</h3>
<div class="paragraph">
<p>If you are having issues which we don&#8217;t cover or otherwise need help, feel free to post to our <a href="https://lists.jboss.org/mailman/listinfo/aerogear-users">mailing list</a>.  Also, messages in logcat may give useful results from Google or StackOverflow.</p>
</div>
</div>
</div>
</div>
      
      </div><!-- col 8 -->
    </div><!-- row -->
  </div><!-- container -->
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-sm-3">
        <h5>Getting Started</h5>
        <ul class="list-unstyled">
          <li><a href="/getting-started/overview/">Overview</a></li>
          <li><a href="/getting-started/installation-and-configuration/">Installation &amp; Configuration</a></li>
          <li><a href="/getting-started/creating-mobile-apps/">Creating Mobile Apps</a></li>
          <li><a href="/getting-started/enabling-mobile-services/">Enabling Mobile Services</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile Services</h5>
        <ul class="list-unstyled">
         <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
         <li><a href="/services/push/">Push Notifications</a></li>
         <li><a href="/services/metrics/">Metrics</a></li>
         <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
         <li><a href="/services/identity-management/">Identity Management</a></li>
         <li><a href="/services/device-security/">Device Security</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile SDKs</h5>
        <ul class="list-unstyled">
         <li><a href="/sdks/android/">Android</a></li>
         <li><a href="/sdks/cordova/">Cordova</li>
         <li><a href="/sdks/ios/">iOS</a></li>
         <li><a href="/sdks/xamarin/">Xamarin</a></li>
        </ul>
      </div><!-- col -->
      
      <div class="col-sm-3">
        <h5>COMMUNITY</h5>
        <ul class="list-unstyled">
          <li><a target="_blank" href="https://github.com/aerogear/">GitHub - Aerogear</a></li>
          <li><a target="_blank" href="https://github.com/aerogearcatalog/">GitHub - Aerogear Catalog</a></li>
          <li><a target="_blank" href="https://issues.jboss.org/browse/AEROGEAR">Jira Repo Issues</a></li>
          <li><a  href="/community/contribution-guide/">Contribution Guide</a></li>
          <li><a target="_blank" href="https://groups.google.com/forum/#!forum/aerogear">Google Group</a></li>
          <li><a href="irc://irc.freenode.net/aerogear">IRC</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-12 follow">
        <h5>FOLLOW US</h5>
        <ul class="list-inline">
          <li><a target="_blank" href="https://www.twitter.com/aerogears"><i class="fa fa-twitter-square"></i> Twitter</a></li>
          <li><a target="_blank" href="https://www.facebook.com/AeroGearProject"><i class="fa fa-facebook-square"></i> Facebook</a></li>
          <li><a target="_blank" href="https://plus.google.com/106588661437153585722/posts"><i class="fa fa-google-plus-square"></i> Google+</a></li>
          <li><a target="_blank" href="/feed.atom"><i class="fa fa-rss-square"></i> Feed</a></li>
        </ul>
        
        <p>AeroGear project is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a></p>
      </div><!-- col -->
    
    </div><!-- row -->

  </div><!-- container -->

</footer><!-- footer -->

<section class="redhat">
  <div class="container">
    <p class="text-center">
      <a href="http://www.redhat.com/">
        <img src="/img/redhatlogo-wite.png" alt="redhatlogo-wite" width="130">
      </a>
    </p>       
  </div><!-- container -->
</section>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!-- <script src="/bower_components/jquery/dist/jquery.min.js"></script> -->

<!-- Include all compiled plugins (below), or include individual files as needed  -->  
<script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- My script -->
<script src="/js/script.js"></script>

</body>
</html>