<!doctype html>
<html>
<head>
  <title>AeroGear - OAuth2Module and OAuth2Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Main styles-->
  <link href="/css/styles.css" rel="stylesheet" media="screen">

  <!-- Syntax highlighting -->
  <link href="/css/syntax.css" rel="stylesheet"> 

  <!-- Icons -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/css/openshift-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>


  <!-- google analytics -->
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28733717-2']);
      _gaq.push(['_setDomainName', 'aerogear.org']);
      _gaq.push(['_trackPageview']);

      (function () {
          var ga = document.createElement('script');
          ga.type = 'text/javascript';
          ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
  </script>
  

</head>

<body>    

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">AeroGear</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        

        <li class="">
          <a href="/">Home</a>
        </li>

        <li class="">
          <a href="/getting-started/overview/">Getting Started</a>
        </li>


        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile Services<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
              <li><a href="/services/push/">Push Notifications</a></li>
              <li><a href="/services/metrics/">Metrics</a></li>
              <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
              <li><a href="/services/identity-management/">Identity Management</a></li>
              <li><a href="/services/device-security/">Device Security</a></li>
            </ul>
        </li>

        <li class="dropdown ">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile SDKs<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/sdks/android/">Android</a></li>
            <li><a href="/sdks/cordova/">Cordova</li>
            <li><a href="/sdks/ios/">iOS</a></li>
            <li><a href="/sdks/xamarin/">Xamarin</a></li>
          </ul>
        </li>

        <li class="hidden-sm ">
          <a href="https://docs.aerogear.org">Docs</a>
        </li>
   
        
        <li class="">
          <a href="/community">Community</a>
        </li>
        

        <li class="">
          <a href="/news">News</a>
        </li>
        
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<section class="main-banner">
  <div class="container">
    
  <h2>Aerogear Guides <small>Tutorials to help get you off and running.</small></h2>

  </div><!-- container -->
</section> <!-- main banner -->


<section class="guides">
  
  <div class="container">
         <ol class="breadcrumb" style="margin:0">
      <li>
        
          <a href="/getstarted/guides/">Guides</a>
        
      </li>
      <li class="active">OAuth2Module and OAuth2Session</li>
    </ol>
  </div><!-- container -->


  <div class="container">
    <div class="row">
      
      <div class="col-md-3 hidden-sm hidden-xs sidebar">
        <ul class="nav">
   <li class="toc_level-1 toc_section-1">
      <a href="#_creating_an_oauth2module">
         <span class="toctext">Creating an OAuth2Module</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-2">
            <a href="#_oauth2module_init">
               <span class="toctext">OAuth2Module init</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-3">
            <a href="#_accountmanager">
               <span class="toctext">AccountManager</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-4">
      <a href="#_extending_oauth2module">
         <span class="toctext">Extending OAuth2Module</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-5">
            <a href="#_keycloak_extension">
               <span class="toctext">Keycloak extension</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-6">
            <a href="#_facebook_extension">
               <span class="toctext">Facebook extension</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-7">
      <a href="#_working_with_http_and_oauth2module">
         <span class="toctext">Working with Http and OAuth2Module</span>
      </a>
      <ul>
         <li class="toc_level-2 toc_section-8">
            <a href="#_explicit_request_access">
               <span class="toctext">Explicit request access</span>
            </a>
         </li>
         <li class="toc_level-2 toc_section-9">
            <a href="#_implicit_request_access">
               <span class="toctext">Implicit request access</span>
            </a>
         </li>
      </ul>
   </li>
   <li class="toc_level-1 toc_section-10">
      <a href="#_refresh_token">
         <span class="toctext">Refresh token</span>
      </a>
   </li>
   <li class="toc_level-1 toc_section-11">
      <a href="#_revoke_access">
         <span class="toctext">Revoke access</span>
      </a>
   </li>
   <li class="toc_level-1 toc_section-12">
      <a href="#_login_using_openid_connect">
         <span class="toctext">Login using OpenID Connect</span>
      </a>
   </li>
</ul>
      </div><!-- col -->
      
      <div class="col-md-9 post">
      
        <h1>OAuth2Module and OAuth2Session</h1>
        <div class="paragraph">
<p>When writing an <a href="https://tools.ietf.org/html/rfc6749">OAuth2</a> application, you often want the user to grant access for only once in the app lifetime. OAuth2Module stores access and refresh tokens in OAuth2Session. OAuth2Session is a protocol which is implemented in 2 flavors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TrustedPersistantOAuth2Session: you store access and refresh tokens permanently in Keychain secure storage,</p>
</li>
<li>
<p>UntrustedMemoryOAuth2Session: tokens are stored in memory without encryption.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s up to you to choose the store, TrustedPersistantOAuth2Session is the default.</p>
</div>
<div class="sect1">
<h2 id="_creating_an_oauth2module">Creating an OAuth2Module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create an OAuth2 module, either use OAuth2Module init or use AccountManager. The later being preferred if you want to create several OAuth2 modules within a same app.</p>
</div>
<div class="sect2">
<h3 id="_oauth2module_init">OAuth2Module init</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    let googleConfig = GoogleConfig(
        clientId: "873670803862-g6pjsgt64gvp7r25edgf4154e8sld5nq.apps.googleusercontent.com",  // [1]
        scopes:["https://www.googleapis.com/auth/drive"])             // [2]

    let gdModule =  OAuth2Module(config: googleConfig)           // [3]</code></pre>
</div>
</div>
<div class="paragraph">
<p>In line [1] and [2], we use the client ID and we specify the scope, here we share with google drive.</p>
</div>
<div class="paragraph">
<p>Line [3], we create an OAuth2 module. By default this module will create a TrustedSessionStorage to permanently store your tokens. Therefore every time your open your app you can POST/GET etc&#8230;&#8203; without having to grant access again. You can choose a less secure UntrustedMemoryOAuth2Session but each time you close your app and reopen it, you will be prompted the first time to grant access.</p>
</div>
</div>
<div class="sect2">
<h3 id="_accountmanager">AccountManager</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    let googleConfig = GoogleConfig(
        clientId: "873670803862-g6pjsgt64gvp7r25edgf4154e8sld5nq.apps.googleusercontent.com",
        scopes:["https://www.googleapis.com/auth/drive"])
        let gdModule = AccountManager.addGoogleAccount(googleConfig)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The AccountManager&#8217;s factory method <em>addAccount:moduleClass:</em> is used to create any OAuth2Module. AccountManager also have utilities method like <em>addFacebookAccount</em> to directly create FacebookOauth2Module.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extending_oauth2module">Extending OAuth2Module</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://tools.ietf.org/html/rfc6749">OAuth2 specification</a> provides different implementation options, it&#8217;s critical when implementing an OAuth2 SDK to offer extensibility. Let&#8217;s show how to use AccountManager to instantiate a KeycloakOauth2Module:</p>
</div>
<div class="sect2">
<h3 id="_keycloak_extension">Keycloak extension</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    var keycloakConfig = Config(base: "http://localhost:8080/auth",
        authzEndpoint: "realms/shoot-realm/tokens/login",
        redirectURL: "org.aerogear.Shoot://oauth2Callback",
        accessTokenEndpoint: "realms/shoot-realm/tokens/access/codes",
        clientId: "shoot-third-party",
        refreshTokenEndpoint: "realms/shoot-realm/tokens/refresh",
        revokeTokenEndpoint: "realms/shoot-realm/tokens/logout")

    let gdModule = AccountManager.addAccount(keycloakConfig, moduleClass: KeycloakOAuth2Module.self)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_facebook_extension">Facebook extension</h3>
<div class="paragraph">
<p>To implement your own <em>OAuth2Module</em> simply inherit from <em>OAuth2Module</em> and override the needed methods. OAuth2Module implements <em>AuthzModule</em> protocol.
For example, check <em>FacebookOAuth2Module</em> where only <em>exchangeAuthorizationCodeForAccessToken:completionHandler</em> and <em>revokeAccess:completionHandler</em> overrides were needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">public class FacebookOAuth2Module: OAuth2Module {

    override public func exchangeAuthorizationCodeForAccessToken(code: String, completionHandler: (AnyObject?, NSError?) -&gt; Void) {
       ....
    }

    override public func revokeAccess(completionHandler: (AnyObject?, NSError?) -&gt; Void) {
        ....
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_working_with_http_and_oauth2module">Working with Http and OAuth2Module</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_explicit_request_access">Explicit request access</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    let googleConfig = GoogleConfig(
        clientId: "873670803862-g6pjsgt64gvp7r25edgf4154e8sld5nq.apps.googleusercontent.com",
        scopes:["https://www.googleapis.com/auth/drive"])

    let gdModule =  OAuth2Module(config: googleConfig)
    var http = Http()                                                                          // [1]
    http.authzModule = gdModule

    gdModule.requestAccess { (response:AnyObject?, error:NSError?) -&gt; Void in                  // [2]
        let filename = self.imageView.accessibilityIdentifier;                                 // [3]
        let multiPartData = MultiPartData(data:UIImageJPEGRepresentation(self.imageView.image, 0.2),
            name: "image",
            filename: filename,
            mimeType: "image/jpg")

        http.POST("https://www.googleapis.com/upload/drive/v2/files", parameters: ["data": multiPartData],
         completionHandler: {(response, error) in  // [6]
            if (error != nil) {
                println("Error uploading file: \(error)")
            } else {
                println("Successfully uploaded: " + response!.description)
            }
        })
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Line [1] we initialize an HTTP object and inject it the OAuth2 module.</p>
</div>
<div class="paragraph">
<p>In line [2], we actually request access. This method checks if the OAuth2Session (here stored in keychain) contains a non-expired access token. If there is no token, it will go through the authorization code grant. If the token is expired (which happens every hour), a refreshed token will be asked transparently without any prompt.</p>
</div>
<div class="paragraph">
<p>In the callback method [3], we can check if the request was successful (check error parameter) and here perform an image upload.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implicit_request_access">Implicit request access</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">   let googleConfig = GoogleConfig(
       clientId: "873670803862-g6pjsgt64gvp7r25edgf4154e8sld5nq.apps.googleusercontent.com",
       scopes:["https://www.googleapis.com/auth/drive"])
    let gdModule = AccountManager.addGoogleAccount(googleConfig)
    self.http.authzModule = gdModule                                    // [1]

    self.http.POST("https://www.googleapis.com/upload/drive/v2/files", parameters:  self.extractImageAsMultipartParams(),
    completionHandler: {(response, error) in
        if (error != nil) {
            self.presentAlert("Error", message: error!.localizedDescription)
        } else {
            self.presentAlert("Success", message: "Successfully uploaded!")
        }
    })</code></pre>
</div>
</div>
<div class="paragraph">
<p>In line [1], inject OAuth2Module in HTTP object. This is an important step, this way you link the HTTP object to the authorization module.</p>
</div>
<div class="paragraph">
<p>Then simply do HTTP calls without checking if there is a valid access token. POST method underneath checks if an OAuth2 module is plugged to HTTP and will make the right call for you :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>either start authz code grant</p>
</li>
<li>
<p>or refresh access code if needed</p>
</li>
<li>
<p>or simply run the POST if all tokens are already available</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refresh_token">Refresh token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Refresh token is handled transparently when using HTTP. You may want to deal with sending a refresh token request yourself as show below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    oauth2Module.refreshAccessToken({(response, error) in
        // do something
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_revoke_access">Revoke access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may want to revoke access tokens for you app by calling revokeAccess as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    oauth2Module.revokeAccess({(response, error) in
        if (error != nil) {
            // do something with error
        }
        // do domething
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_login_using_openid_connect">Login using OpenID Connect</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OpenID Connect is a simple identity layer on top of the OAuth 2.0 protocol. It allows clients to verify the identity of the user based on the authentication performed by an Authorization Server, as well as to obtain basic profile information about the user.</p>
</div>
<div class="paragraph">
<p>On top of OAuth2 authorization grant flow, you can use <strong>login</strong> which behaves the same way as <strong>requestAccess</strong>:
1. check if access token is valid, if already there just run callback method
2. if not valid and refresh token present, go and fetch new access token
3. if none of the above, trigger a pop-up to authenticate and grant access. Additional scope is required to retrieve user profile information.</p>
</div>
<div class="paragraph">
<p>See code snippet below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">  var Http = Http()
  let keycloakConfig = KeycloakConfig(
    clientId: "sharedshoot-third-party",
    host: "http://localhost:8080",
    realm: "shoot-realm",
    isOpenIDConnect: true)
  var oauth2Module = AccountManager.addKeycloakAccount(keycloakConfig)
  http.authzModule = oauth2Module
  oauth2Module.login {(accessToken: AnyObject?, claims: OpenIDClaim?, error: NSError?) in // [1]
    // Do your own stuff here
  }</code></pre>
</div>
</div>
</div>
</div>
      
      </div><!-- col 8 -->
    </div><!-- row -->
  </div><!-- container -->
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-sm-3">
        <h5>Getting Started</h5>
        <ul class="list-unstyled">
          <li><a href="/getting-started/overview/">Overview</a></li>
          <li><a href="/getting-started/installation-and-configuration/">Installation &amp; Configuration</a></li>
          <li><a href="/getting-started/creating-mobile-apps/">Creating Mobile Apps</a></li>
          <li><a href="/getting-started/enabling-mobile-services/">Enabling Mobile Services</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile Services</h5>
        <ul class="list-unstyled">
         <li><a href="/services/mobile-ci-cd/">Mobile CI/CD</a></li>
         <li><a href="/services/push/">Push Notifications</a></li>
         <li><a href="/services/metrics/">Metrics</a></li>
         <li><a href="/services/runtime-connector/">Runtime Connector</a></li>
         <li><a href="/services/identity-management/">Identity Management</a></li>
         <li><a href="/services/device-security/">Device Security</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-3">
        <h5>Mobile SDKs</h5>
        <ul class="list-unstyled">
         <li><a href="/sdks/android/">Android</a></li>
         <li><a href="/sdks/cordova/">Cordova</li>
         <li><a href="/sdks/ios/">iOS</a></li>
         <li><a href="/sdks/xamarin/">Xamarin</a></li>
        </ul>
      </div><!-- col -->
      
      <div class="col-sm-3">
        <h5>COMMUNITY</h5>
        <ul class="list-unstyled">
          <li><a target="_blank" href="https://github.com/aerogear/">GitHub - Aerogear</a></li>
          <li><a target="_blank" href="https://github.com/aerogearcatalog/">GitHub - Aerogear Catalog</a></li>
          <li><a target="_blank" href="https://issues.jboss.org/browse/AEROGEAR">Jira Repo Issues</a></li>
          <li><a  href="/community/contribution-guide/">Contribution Guide</a></li>
          <li><a target="_blank" href="https://groups.google.com/forum/#!forum/aerogear">Google Group</a></li>
          <li><a href="irc://irc.freenode.net/aerogear">IRC</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-12 follow">
        <h5>FOLLOW US</h5>
        <ul class="list-inline">
          <li><a target="_blank" href="https://www.twitter.com/aerogears"><i class="fa fa-twitter-square"></i> Twitter</a></li>
          <li><a target="_blank" href="https://www.facebook.com/AeroGearProject"><i class="fa fa-facebook-square"></i> Facebook</a></li>
          <li><a target="_blank" href="https://plus.google.com/106588661437153585722/posts"><i class="fa fa-google-plus-square"></i> Google+</a></li>
          <li><a target="_blank" href="/feed.atom"><i class="fa fa-rss-square"></i> Feed</a></li>
        </ul>
        
        <p>AeroGear project is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a></p>
      </div><!-- col -->
    
    </div><!-- row -->

  </div><!-- container -->

</footer><!-- footer -->

<section class="redhat">
  <div class="container">
    <p class="text-center">
      <a href="http://www.redhat.com/">
        <img src="/img/redhatlogo-wite.png" alt="redhatlogo-wite" width="130">
      </a>
    </p>       
  </div><!-- container -->
</section>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!-- <script src="/bower_components/jquery/dist/jquery.min.js"></script> -->

<!-- Include all compiled plugins (below), or include individual files as needed  -->  
<script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- My script -->
<script src="/js/script.js"></script>

</body>
</html>